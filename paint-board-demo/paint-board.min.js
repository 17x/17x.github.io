(()=>{"use strict";const t=/Android|iPhone|iPad|iPod|SymbianOS|Windows Phone/.test(navigator.userAgent),e=t?["touchstart","touchmove","touchend"]:["mousedown","mousemove","mouseup"],n=({canvas:t,event:e})=>{let n,i,s=t.getBoundingClientRect(),a=t.width,r=t.height,o=e.x-s.x,l=e.y-s.y;return n=a*(o/s.width),i=r*(l/s.height),{x:n,y:i}},i=({ctx:t,start:e,end:n,strokeWidth:i=1,strokeColor:s="#000000",antiAliasing:a=!1})=>{t.save();for(let a=0;a<1;a++)t.beginPath(),t.lineCap="round",t.lineWidth=i,"transparent"===s?(t.strokeStyle="#ffffff",t.globalCompositeOperation="destination-out"):t.strokeStyle=s,t.moveTo(e.x,e.y),t.lineTo(n.x,n.y),t.stroke();t.restore()},s=(()=>{let s=null,a=null;return{Start:function(){s=this.canvas,a=this.ctx;const r=t=>{t.preventDefault()};let o=null;const l=e=>{let{strokeWidth:r,strokeColor:l}=this.strokeConfig,h=t?e.touches[0].pageX:e.x,c=t?e.touches[0].pageY:e.y,u=n({canvas:s,event:{x:h,y:c}});this.Operating(),i({start:o,end:u,ctx:a,strokeWidth:r,strokeColor:l}),o=u,e.preventDefault()},h=()=>{this.OperatingEnd(),document.removeEventListener(e[1],l),document.removeEventListener("selectstart",r),document.removeEventListener(e[2],h)};s["on"+e[0]]=c=>{let{strokeWidth:u,strokeColor:d}=this.strokeConfig,g=t?c.touches[0].pageX:c.x,p=t?c.touches[0].pageY:c.y;o=n({canvas:s,event:{x:g,y:p}}),this.OperatingStart(),i({start:o,end:o,ctx:a,strokeWidth:u,strokeColor:d}),document.addEventListener(e[1],l,{passive:!1}),document.addEventListener("selectstart",r),document.addEventListener(e[2],h)}},Quit:function(){s["on"+e[0]]=null}}})(),a=({type:t,ctx:e,fillStyle:n,param:i})=>{if(e.save(),e.beginPath(),"transparent"===n?(e.fillStyle="#fff",e.globalCompositeOperation="destination-out"):e.fillStyle=n,"circle"===t)((t,{x:e,y:n,radiusX:i,radiusY:s,rotation:a=2*Math.PI,startAngle:r=0,endAngle:o=2*Math.PI,counterclockwise:l=1})=>{t.ellipse(e,n,i,s,a,r,o,l)})(e,i);else if("rect"===t){let{x:t,y:n,w:s,h:a}=i;e.fillRect(t,n,s,a)}e.fill(),e.restore()},r=(()=>{let s=null,r=null,o=[],l=null,h=null,c=!0;const u=t=>{let e=document.createElement("canvas"),n=e.getContext("2d");return e.width=t.width,e.height=t.height,n.drawImage(t,0,0),e},d=e=>{if(o.length>0){let i=t?e.touches[0].pageX:e.x,a=t?e.touches[0].pageY:e.y,r=n({canvas:s,event:{x:i,y:a}}),l=o[o.length-1];l.x=r.x,l.y=r.y,g()}e.preventDefault()},g=()=>{let{strokeWidth:t,strokeColor:e}=l.strokeConfig,{width:n,height:s}=l.canvas,c=o[0],u=o[1];r.clearRect(0,0,n,s),r.drawImage(h,0,0),c&&(u?(u?i({ctx:r,start:c,end:u,strokeWidth:t,strokeColor:e}):a({ctx:r,type:"circle",fillStyle:"#000000",param:{x:c.x,y:c.y,radiusX:1,radiusY:1}}),i({ctx:r,start:c,end:u,strokeWidth:t,strokeColor:e})):a({ctx:r,type:"circle",fillStyle:"#000000",param:{x:c.x,y:c.y,radiusX:1,radiusY:1}}))},p=()=>{o.length=0,g()},y=()=>{h=u(l.canvas)};return{name:"polygon",Start:function(){h=u(this.canvas),o=[],l=this,s=this.canvas,r=this.ctx;const i=t=>{t.preventDefault()},a=()=>{2===o.length&&(c=!0,o.length=0,this.OperatingEnd(),y()),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],a),document.removeEventListener(e[1],d)};s["on"+e[0]]=r=>{if(!t&&1!==r.buttons)return;let l=t?r.touches[0].pageX:r.x,h=t?r.touches[0].pageY:r.y,u=n({canvas:s,event:{x:l,y:h}});c&&(this.OperatingStart(),c=!1),o.push(u),g(),document.addEventListener(e[1],d,{passive:!1}),document.addEventListener("selectstart",i),document.addEventListener(e[2],a)},s.oncontextmenu=t=>{t.preventDefault(),p(),this.OperatingEnd(),h=u(s)}},Quit:function(){p(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],d)},UpdateClone:y}})(),o=(()=>{let s=null,r=null;return{Start:function(){let o=null;s=this.canvas,r=this.ctx;const l=t=>{t.preventDefault()},h=e=>{let{clearRadius:l,clearColor:h}=this,c=t?e.touches[0].pageX:e.x,u=t?e.touches[0].pageY:e.y,d=n({canvas:s,event:{x:c,y:u}});this.Operating(),o?i({start:o,end:d,ctx:r,strokeWidth:2*l,strokeColor:h}):a({ctx:r,type:"circle",fillStyle:h,param:{x:d.x,y:d.y,radiusX:l,radiusY:l}}),o=d,e.preventDefault()},c=()=>{o=null,this.OperatingEnd(),document.removeEventListener(e[1],h),document.removeEventListener("selectstart",l),document.removeEventListener(e[2],c)};s["on"+e[0]]=i=>{let{clearRadius:o,clearColor:u}=this,d=t?i.touches[0].pageX:i.x,g=t?i.touches[0].pageY:i.y,p=n({canvas:s,event:{x:d,y:g}});this.OperatingStart(),a({ctx:r,type:"circle",fillStyle:u,param:{x:p.x,y:p.y,radiusX:o,radiusY:o}}),document.addEventListener(e[1],h,{passive:!1}),document.addEventListener("selectstart",l),document.addEventListener(e[2],c)}},Quit:function(){s["on"+e[0]]=null}}})(),l=(()=>{let s=null,a=null,r=[],o=null,l=null,h=!0;const c=t=>{let e=document.createElement("canvas"),n=e.getContext("2d");return e.width=t.width,e.height=t.height,n.drawImage(t,0,0),e},u=e=>{if(r.length>0){let i=t?e.touches[0].pageX:e.x,a=t?e.touches[0].pageY:e.y,o=n({canvas:s,event:{x:i,y:a}}),l=r[r.length-1];l.x=o.x,l.y=o.y,d()}},d=()=>{let{strokeWidth:t,strokeColor:e}=o.strokeConfig,{width:n,height:s}=o.canvas;a.clearRect(0,0,n,s),a.drawImage(l,0,0);for(let n=0;n<r.length;n++){let s=null,o=r[n];s=0===r.length?o:0===n?r[r.length-1]:r[n-1],i({ctx:a,start:s,end:o,strokeWidth:t,strokeColor:e})}},g=()=>{t||r.length>0&&(r.length-=1),r.length<3&&(r.length=0),d(),r.length=0};return{name:"polygon",Start:function(){l=c(this.canvas),r=[],o=this,s=this.canvas,a=this.ctx;const i=t=>{t.preventDefault()},p=()=>{if(0!==r.length){if(!t){let{x:t,y:e}=r[r.length-1];r.push({x:t,y:e})}r.length>3&&this.OperatingEnd(),d(),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],p)}};s["on"+e[0]]=a=>{if(!t&&1!==a.buttons)return;let o=t?a.touches[0].pageX:a.x,l=t?a.touches[0].pageY:a.y,c=n({canvas:s,event:{x:o,y:l}});(t||0===r.length)&&r.push({...c}),h&&(this.OperatingStart(),h=!1),document.addEventListener("selectstart",i),document.addEventListener(e[2],p)},s.oncontextmenu=t=>{t.preventDefault(),g(),this.OperatingEnd(),l=c(s)},t||document.addEventListener(e[1],u)},Quit:function(){g(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],u)},UpdateClone:()=>{l=c(o.canvas)}}})();let h=!1,c=!1;const u=(t,e)=>{var n=0;return Object.keys(t).map((i=>{n+=(t[i]-e[i])**2})),Math.sqrt(n)},d=({imageData:t,coord:e})=>{let{x:n,y:i}=e,{width:s,height:a,data:r}=t;var o=i*(4*s)+4*n;return{r:r[o],g:r[o+1],b:r[o+2],a:r[o+3]}};function g(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const p={pen:s,line:r,eraser:o,polygon:l,paintBucket:(()=>{let i=null,s=null,a=!1;return{Start:function(){i=this.canvas,s=this.ctx,i["on"+e[0]]=e=>{if(a)return void console.log("bucket doing");let{strokeColor:r}=this.strokeConfig,o=t?e.touches[0].pageX:e.x,l=t?e.touches[0].pageY:e.y,g=n({canvas:i,event:{x:o,y:l}});this.OperatingStart(),(({ctx:t,currCoord:e,inputColor:n,cb:i})=>{let s=Math.round(e.x),a=Math.round(e.y),{width:r,height:o}=t.canvas,l=t.getImageData(0,0,r,o),g=d({coord:{x:s,y:a},imageData:l}),p={},y=[[s,a]],v=!1,f=null;if(c)console.warn("task running.");else if(c=!0,h=!1,n=(t=>{let e;if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t))return e=t.substring(1).split(""),3===e.length&&(e=[e[0],e[0],e[1],e[1],e[2],e[2]]),e="0x"+e.join(""),{r:e>>16&255,g:e>>8&255,b:255&e,a:255};throw new Error("Bad Hex")})(n),0!==u(n,g))try{!function e(){let n=y;if(v=!1,f=500,y=[],h)throw c=!1,new Error("User interrupt");for(let t of n){let[e,n]=t;x(e,n)}v?setTimeout((function(){e()}),0):(c=!1,t.putImageData(l,0,0),i&&i("done"))}()}catch(t){i&&i(t)}else i&&i("same color");function x(t,e){if(h)return;if(p[t+"_"+e]&&p[t+"_"+e]++,f--<0)return v=!0,void y.push([t,e]);let i=d({coord:{x:t,y:e},imageData:l});if(u(g,i)<10){(({imageData:t,coord:e,rgba:n})=>{let{x:i,y:s}=e,{width:a,height:r,data:o}=t;var l=s*(4*a)+4*i;let{r:h,g:c,b:u,a:d}=n;d=d||255,o[l]=h,o[l+1]=c,o[l+2]=u,o[l+3]=d})({imageData:l,rgba:n,coord:{x:t,y:e}}),p[t+"_"+e]=!0;for(let n=t-1;n<t+2;n++)for(let t=e-1;t<e+2;t++)0<=n&&n<r&&0<=t&&t<o&&!p[n+"_"+t]&&(p[n+"_"+t]=!0,x(n,t))}}})({inputColor:r,currCoord:g,ctx:s,cb:t=>{a=!1,this.OperatingEnd()}})}},Quit:function(){h=!0,i["on"+e[0]]=null}}})()};window.PaintBoard=class{constructor({canvas:t,strokeConfig:e={},clearColor:n="#ffffff",clearRadius:i=16,enableHistory:s=!1,historyMax:a=10,historyInterval:r=500,background:o,...l}){g(this,"lastOperatingEnd",null),g(this,"isContinuous",null),g(this,"currentTool",null),g(this,"strokeConfig",{strokeWidth:1,strokeColor:"#000000"}),this.props=l;let h=this.props;if(h.logicalWidth=Math.round(h.logicalWidth),h.logicalHeight=Math.round(h.logicalHeight),t.width=h.logicalWidth,t.height=h.logicalHeight,Object.assign(this.strokeConfig,e),o){let{image:e,color:n}=o;t.style.background="".concat(n||""," url(").concat(e.src,") 0 0 no-repeat"),t.style.backgroundSize="contain"}this.background=o,this.clearColor=n,this.historyInterval=r,this.clearRadius=i,this.canvas=t,this.ctx=t.getContext("2d"),s&&(this.enableHistory=s,this.historyMax=a,this.historyIndex=-1,this.historyStack=[]),this.Clear()}Tool(t){const e=p[t];this.currentTool?(this.currentTool.Quit(),this.currentTool===e?this.currentTool=null:(this.currentTool=e,e.Start.apply(this))):(this.currentTool=e,e.Start.apply(this))}Method(t){this[t=t.substr(0,1).toUpperCase()+t.substr(1,t.length)](),this.currentTool&&"polygon"===this.currentTool.name&&this.currentTool.UpdateClone()}OperatingStart(){this.enableHistory&&(this.isClean=!1,this.ClearRedoList(),this.isContinuous=Date.now()-this.lastOperatingEnd<this.historyInterval)}Operating(){}OperatingEnd(){this.lastOperatingEnd=Date.now(),this.enableHistory&&(this.Snapshot(this.isContinuous),this.lastOperatingEnd=Date.now())}Clear(){if(this.CleanBoard(),this.enableHistory){this.ClearRedoList();let t=this.historyStack[this.historyIndex];if(t&&"clear"===t.t)return;this.historyIndex+=1,this.Snapshot()}}CleanBoard(){this.ctx.save(),"transparent"===this.clearColor?(this.ctx.fillStyle="#ffffff",this.ctx.globalCompositeOperation="destination-out"):this.ctx.fillStyle=this.clearColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}ClearRedoList(){this.historyStack.length=this.historyIndex+1}ApplyHistory(){let t=this.historyStack[this.historyIndex];if(t)if("init"===t.t||"clear"===t.t)this.CleanBoard(),this.isClean=!0;else{let e=new ImageData(t.data,this.canvas.width,this.canvas.height);this.ctx.putImageData(e,0,0)}}Undo(){this.enableHistory&&0!==this.historyStack.length&&(this.historyIndex-=1,this.historyIndex<0&&(this.historyIndex=0),this.ApplyHistory())}Redo(){this.enableHistory&&0!==this.historyStack.length&&(this.historyIndex+=1,this.historyIndex>this.historyStack.length-1?this.historyIndex=this.historyStack.length-1:this.ApplyHistory())}Snapshot(t=!1){let e=null;e=this.isClean?{t:"clear"}:{time:Date.now(),data:this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height).data},t&&this.historyStack.pop(),this.historyStack.length>=this.historyMax&&this.historyStack.shift(),this.historyStack.push(e),this.historyIndex=this.historyStack.length-1}SaveData({returnType:t="arraybuffer",compBg:e=!1,cb:n}){let i,{logicalWidth:s,logicalHeight:a}=this.props;if(e){let t,{image:e}=this.background;i=document.createElement("canvas"),i.width=s,i.height=a,t=i.getContext("2d"),t.drawImage(e,0,0,s,a),t.drawImage(this.canvas,0,0,s,a)}else i=this.canvas;if("file"===t)i.toBlob((t=>{let e=new File([t],"user-board.png",{lastModified:new Date});n(e)}),"image/png");else{if("arraybuffer"===t)return this.ctx.getImageData(0,0,s,a).data.buffer;if("base64"===t)return i.toDataURL("image/png")}}}})();