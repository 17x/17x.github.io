(()=>{"use strict";var t=/Android|iPhone|iPad|iPod|SymbianOS|Windows Phone/.test(navigator.userAgent),e=t?["touchstart","touchmove","touchend"]:["mousedown","mousemove","mouseup"];const n=function(t){var e=t.canvas,n=t.event,r=e.getBoundingClientRect(),o=e.width,i=e.height,a=n.x-r.x,s=n.y-r.y;return{x:o*(a/r.width),y:i*(s/r.height)}},r=function(t){for(var e=t.ctx,n=t.start,r=t.end,o=t.strokeWidth,i=void 0===o?1:o,a=t.strokeColor,s=void 0===a?"#000000":a,l=(t.antiAliasing,0);l<1;l++)e.beginPath(),e.lineCap="round",e.lineWidth=i,"transparent"===s?(e.strokeStyle="#ffffff",e.globalCompositeOperation="destination-out"):e.strokeStyle=s,e.moveTo(n.x,n.y),e.lineTo(r.x,r.y),e.stroke()};var o,i;const a=(o=null,i=null,{Start:function(){var a=this;o=this.canvas,i=this.ctx;var s=function(t){t.preventDefault()},l=null,c=function(e){var s=a.strokeConfig,c=s.strokeWidth,u=s.strokeColor,h=t?e.touches[0].pageX:e.x,d=t?e.touches[0].pageY:e.y,f=n({canvas:o,event:{x:h,y:d}});a.Operating(),r({start:l,end:f,ctx:i,strokeWidth:c,strokeColor:u}),l=f},u=function t(){a.OperatingEnd(),document.removeEventListener(e[1],c),document.removeEventListener("selectstart",s),document.removeEventListener(e[2],t)};o["on"+e[0]]=function(h){var d=a.strokeConfig,f=d.strokeWidth,v=d.strokeColor,g=t?h.touches[0].pageX:h.x,y=t?h.touches[0].pageY:h.y;l=n({canvas:o,event:{x:g,y}}),a.OperatingStart(),r({start:l,end:l,ctx:i,strokeWidth:f,strokeColor:v}),document.addEventListener(e[1],c),document.addEventListener("selectstart",s),document.addEventListener(e[2],u)}},Quit:function(){o["on"+e[0]]=null}}),s=function(t){var e=t.type,n=t.ctx,r=t.fillStyle,o=t.param;if(n.save(),n.beginPath(),"transparent"===r?(n.fillStyle="#fff",n.globalCompositeOperation="destination-out"):n.fillStyle=r,"circle"===e)!function(t,e){var n=e.x,r=e.y,o=e.radiusX,i=e.radiusY,a=e.rotation,s=void 0===a?2*Math.PI:a,l=e.startAngle,c=void 0===l?0:l,u=e.endAngle,h=void 0===u?2*Math.PI:u,d=e.counterclockwise,f=void 0===d?1:d;t.ellipse(n,r,o,i,s,c,h,f)}(n,o);else if("rect"===e){var i=o.x,a=o.y,s=o.w,l=o.h;n.fillRect(i,a,s,l)}n.fill(),n.restore()},l=function(){var o=null,i=null,a=[],l=null,c=null,u=!0,h=function(t){var e=document.createElement("canvas"),n=e.getContext("2d");return e.width=t.width,e.height=t.height,n.drawImage(t,0,0),e},d=function(e){if(a.length>0){var r=t?e.touches[0].pageX:e.x,i=t?e.touches[0].pageY:e.y,s=n({canvas:o,event:{x:r,y:i}}),l=a[a.length-1];l.x=s.x,l.y=s.y,f()}},f=function(){var t=l.strokeConfig,e=t.strokeWidth,n=t.strokeColor,o=l.canvas,u=o.width,h=o.height,d=a[0],f=a[1];i.clearRect(0,0,u,h),i.drawImage(c,0,0),d&&(f?(f?r({ctx:i,start:d,end:f,strokeWidth:e,strokeColor:n}):s({ctx:i,type:"circle",fillStyle:"#000000",param:{x:d.x,y:d.y,radiusX:1,radiusY:1}}),r({ctx:i,start:d,end:f,strokeWidth:e,strokeColor:n})):s({ctx:i,type:"circle",fillStyle:"#000000",param:{x:d.x,y:d.y,radiusX:1,radiusY:1}}))},v=function(){a.length=0,f()},g=function(){c=h(l.canvas)};return{name:"polygon",Start:function(){var r=this;c=h(this.canvas),a=[],l=this,o=this.canvas,i=this.ctx;var s=function(t){t.preventDefault()},y=function t(){2===a.length&&(u=!0,a.length=0,r.OperatingEnd(),g()),document.removeEventListener("selectstart",s),document.removeEventListener(e[2],t),document.removeEventListener(e[1],d)};o["on"+e[0]]=function(i){if(t||1===i.buttons){var l=t?i.touches[0].pageX:i.x,c=t?i.touches[0].pageY:i.y,h=n({canvas:o,event:{x:l,y:c}});u&&(r.OperatingStart(),u=!1),a.push(h),f(),document.addEventListener("selectstart",s),document.addEventListener(e[2],y),document.addEventListener(e[1],d)}},o.oncontextmenu=function(t){t.preventDefault(),v(),r.OperatingEnd(),c=h(o)}},Quit:function(){v(),o.oncontextmenu=null,o["on"+e[0]]=null,t||document.removeEventListener(e[1],d)},UpdateClone:g}}(),c=function(){var o=null,i=null;return{Start:function(){var a=this,l=null;o=this.canvas,i=this.ctx;var c=function(t){t.preventDefault()},u=function(e){var c=a.clearRadius,u=a.clearColor,h=t?e.touches[0].pageX:e.x,d=t?e.touches[0].pageY:e.y,f=n({canvas:o,event:{x:h,y:d}});a.Operating(),l?r({start:l,end:f,ctx:i,strokeWidth:2*c,strokeColor:u}):s({ctx:i,type:"circle",fillStyle:u,param:{x:f.x,y:f.y,radiusX:c,radiusY:c}}),l=f},h=function t(){l=null,a.OperatingEnd(),document.removeEventListener(e[1],u),document.removeEventListener("selectstart",c),document.removeEventListener(e[2],t)};o["on"+e[0]]=function(r){var l=a.clearRadius,d=a.clearColor,f=t?r.touches[0].pageX:r.x,v=t?r.touches[0].pageY:r.y,g=n({canvas:o,event:{x:f,y:v}});a.OperatingStart(),s({ctx:i,type:"circle",fillStyle:d,param:{x:g.x,y:g.y,radiusX:l,radiusY:l}}),document.addEventListener(e[1],u),document.addEventListener("selectstart",c),document.addEventListener(e[2],h)}},Quit:function(){o["on"+e[0]]=null}}}();function u(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function h(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const d=function(){var o=null,i=null,a=[],s=null,l=null,c=!0,d=function(t){var e=document.createElement("canvas"),n=e.getContext("2d");return e.width=t.width,e.height=t.height,n.drawImage(t,0,0),e},f=function(e){if(a.length>0){var r=t?e.touches[0].pageX:e.x,i=t?e.touches[0].pageY:e.y,s=n({canvas:o,event:{x:r,y:i}}),l=a[a.length-1];l.x=s.x,l.y=s.y,v()}},v=function(){var t=s.strokeConfig,e=t.strokeWidth,n=t.strokeColor,o=s.canvas,c=o.width,u=o.height;i.clearRect(0,0,c,u),i.drawImage(l,0,0);for(var h=0;h<a.length;h++){var d,f=a[h];d=0===a.length?f:0===h?a[a.length-1]:a[h-1],r({ctx:i,start:d,end:f,strokeWidth:e,strokeColor:n})}},g=function(){t||a.length>0&&(a.length-=1),a.length<3&&(a.length=0),v(),a.length=0};return{name:"polygon",Start:function(){var r=this;l=d(this.canvas),a=[],s=this,o=this.canvas,i=this.ctx;var y=function(t){t.preventDefault()},p=function n(){if(0!==a.length){if(!t){console.log(a);var o=a[a.length-1],i=o.x,s=o.y;a.push({x:i,y:s})}a.length>3&&r.OperatingEnd(),v(),document.removeEventListener("selectstart",y),document.removeEventListener(e[2],n)}};o["on"+e[0]]=function(i){if(t||1===i.buttons){var s=t?i.touches[0].pageX:i.x,l=t?i.touches[0].pageY:i.y,d=n({canvas:o,event:{x:s,y:l}});(t||0===a.length)&&a.push(function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?u(Object(n),!0).forEach((function(e){h(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}({},d)),c&&(r.OperatingStart(),c=!1),document.addEventListener("selectstart",y),document.addEventListener(e[2],p)}},o.oncontextmenu=function(t){t.preventDefault(),g(),r.OperatingEnd(),l=d(o)},t||document.addEventListener(e[1],f)},Quit:function(){g(),o.oncontextmenu=null,o["on"+e[0]]=null,t||document.removeEventListener(e[1],f)},UpdateClone:function(){l=d(s.canvas)}}}();function f(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var v=!1,g=!1,y=function(t,e){var n=0;return Object.keys(t).map((function(r){n+=Math.pow(t[r]-e[r],2)})),Math.sqrt(n)},p=function(t){var e=t.imageData,n=t.coord,r=n.x,o=n.y,i=e.width,a=(e.height,e.data),s=o*(4*i)+4*r;return{r:a[s],g:a[s+1],b:a[s+2],a:a[s+3]}},m=function(){var r=null,o=null,i=!1;return{Start:function(){var a=this;r=this.canvas,o=this.ctx,r["on"+e[0]]=function(e){if(i)console.log("bucket doing");else{var s=a.strokeConfig.strokeColor,l=t?e.touches[0].pageX:e.x,c=t?e.touches[0].pageY:e.y,u=n({canvas:r,event:{x:l,y:c}});a.OperatingStart(),function(t){var e=t.ctx,n=t.currCoord,r=t.inputColor,o=t.cb,i=Math.round(n.x),a=Math.round(n.y),s=e.canvas,l=s.width,c=s.height,u=e.getImageData(0,0,l,c),h=p({coord:{x:i,y:a},imageData:u}),d={},m=[[i,a]],x=!1,b=null;if(g)console.warn("task running.");else if(g=!0,v=!1,r=function(t){var e;if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t))return 3===(e=t.substring(1).split("")).length&&(e=[e[0],e[0],e[1],e[1],e[2],e[2]]),{r:(e="0x"+e.join(""))>>16&255,g:e>>8&255,b:255&e,a:255};throw new Error("Bad Hex")}(r),0!==y(r,h))try{!function t(){var n,r,i=m;if(x=!1,b=500,m=[],v)throw g=!1,new Error("User interrupt");for(var a=0,s=i;a<s.length;a++){var l=(n=s[a],r=2,function(t){if(Array.isArray(t))return t}(n)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,i=[],a=!0,s=!1;try{for(n=n.call(t);!(a=(r=n.next()).done)&&(i.push(r.value),!e||i.length!==e);a=!0);}catch(t){s=!0,o=t}finally{try{a||null==n.return||n.return()}finally{if(s)throw o}}return i}}(n,r)||function(t,e){if(t){if("string"==typeof t)return f(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?f(t,e):void 0}}(n,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}());k(l[0],l[1])}x?setTimeout((function(){t()}),0):(g=!1,e.putImageData(u,0,0),o&&o("done"))}()}catch(t){console.log(t),o&&o(t)}else o&&o("same color");function k(t,e){if(!v){if(d[t+"_"+e]&&d[t+"_"+e]++,b--<0)return x=!0,void m.push([t,e]);var n=p({coord:{x:t,y:e},imageData:u});if(y(h,n)<10){(function(t){var e=t.imageData,n=t.coord,r=t.rgba,o=n.x,i=n.y,a=e.width,s=(e.height,e.data),l=i*(4*a)+4*o,c=r.r,u=r.g,h=r.b,d=r.a;d=d||255,s[l]=c,s[l+1]=u,s[l+2]=h,s[l+3]=d})({imageData:u,rgba:r,coord:{x:t,y:e}}),d[t+"_"+e]=!0;for(var o=t-1;o<t+2;o++)for(var i=e-1;i<e+2;i++)0<=o&&o<l&&0<=i&&i<c&&!d[o+"_"+i]&&(d[o+"_"+i]=!0,k(o,i))}}}}({inputColor:s,currCoord:u,ctx:o,cb:function(t){console.log("msg in cb",t),i=!1,a.OperatingEnd()}})}}},Quit:function(){v=!0,r["on"+e[0]]=null}}}(),x=["canvas","strokeConfig","clearColor","clearRadius","enableHistory","historyMax","background"];function b(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function k(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var C={pen:a,line:l,eraser:c,polygon:d,paintBucket:m},w=function(){function t(e){var n=e.canvas,r=e.strokeConfig,o=void 0===r?{}:r,i=e.clearColor,a=void 0===i?"#ffffff":i,s=e.clearRadius,l=void 0===s?16:s,c=e.enableHistory,u=void 0!==c&&c,h=e.historyMax,d=void 0===h?10:h,f=e.background,v=function(t,e){if(null==t)return{};var n,r,o=function(t,e){if(null==t)return{};var n,r,o={},i=Object.keys(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}(e,x);!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),k(this,"lastOperatingEnd",null),k(this,"isContinuous",null),k(this,"currentTool",null),k(this,"strokeConfig",{strokeWidth:1,strokeColor:"#000000"}),this.props=v;var g=this.props;if(g.logicalWidth=Math.round(g.logicalWidth),g.logicalHeight=Math.round(g.logicalHeight),n.width=g.logicalWidth,n.height=g.logicalHeight,Object.assign(this.strokeConfig,o),f){var y=f.image,p=f.color;n.style.background="".concat(p||""," url(").concat(y.src,") 0 0 no-repeat"),n.style.backgroundSize="contain"}this.background=f,this.clearColor=a,this.clearRadius=l,this.canvas=n,this.ctx=n.getContext("2d"),u&&(this.enableHistory=u,this.historyMax=d,this.historyIndex=-1,this.historyStack=[]),this.Clear()}var e,n;return e=t,(n=[{key:"Tool",value:function(t){var e=C[t];this.currentTool?(this.currentTool.Quit(),this.currentTool===e?this.currentTool=null:(this.currentTool=e,e.Start.apply(this))):(this.currentTool=e,e.Start.apply(this))}},{key:"Method",value:function(t){this[t=t.substr(0,1).toUpperCase()+t.substr(1,t.length)](),this.currentTool&&"polygon"===this.currentTool.name&&this.currentTool.UpdateClone()}},{key:"OperatingStart",value:function(){this.enableHistory&&(this.isClean=!1,this.ClearRedoList(),this.isContinuous=Date.now()-this.lastOperatingEnd<1e3)}},{key:"Operating",value:function(){}},{key:"OperatingEnd",value:function(){this.lastOperatingEnd=Date.now(),this.enableHistory&&(this.Snapshot(this.isContinuous),this.lastOperatingEnd=Date.now())}},{key:"Clear",value:function(){if(this.CleanBoard(),this.enableHistory){this.ClearRedoList();var t=this.historyStack[this.historyIndex];if(t&&"clear"===t.t)return;this.historyIndex+=1,this.Snapshot()}}},{key:"CleanBoard",value:function(){this.ctx.save(),"transparent"===this.clearColor?(this.ctx.fillStyle="#ffffff",this.ctx.globalCompositeOperation="destination-out"):this.ctx.fillStyle=this.clearColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}},{key:"ClearRedoList",value:function(){this.historyStack.length=this.historyIndex+1}},{key:"ApplyHistory",value:function(){var t=this.historyStack[this.historyIndex];if(t)if("init"===t.t||"clear"===t.t)this.CleanBoard(),this.isClean=!0;else{var e=new ImageData(t.data,this.canvas.width,this.canvas.height);this.ctx.putImageData(e,0,0)}}},{key:"Undo",value:function(){this.enableHistory&&0!==this.historyStack.length&&(console.log("Undo"),this.historyIndex-=1,this.historyIndex<0&&(this.historyIndex=0),this.ApplyHistory(),console.log(this.historyIndex))}},{key:"Redo",value:function(){this.enableHistory&&0!==this.historyStack.length&&(this.historyIndex+=1,this.historyIndex>this.historyStack.length-1?this.historyIndex=this.historyStack.length-1:this.ApplyHistory())}},{key:"Snapshot",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=null;e=this.isClean?{t:"clear"}:{time:Date.now(),data:this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height).data},t&&this.historyStack.pop(),this.historyStack.length>=this.historyMax&&this.historyStack.shift(),this.historyStack.push(e),this.historyIndex=this.historyStack.length-1}},{key:"SaveData",value:function(t){var e,n=t.returnType,r=void 0===n?"arraybuffer":n,o=t.compBg,i=void 0!==o&&o,a=t.cb,s=this.props,l=s.logicalWidth,c=s.logicalHeight;if(i){var u,h=this.background.image;(e=document.createElement("canvas")).width=l,e.height=c,(u=e.getContext("2d")).drawImage(h,0,0,l,c),u.drawImage(this.canvas,0,0,l,c),document.body.appendChild(e)}else e=this.canvas;if("file"===r)e.toBlob((function(t){var e=new File([t],"user-board.png",{lastModified:new Date});a(e)}),"image/png");else{if("arraybuffer"===r)return this.ctx.getImageData(0,0,l,c).data.buffer;if("base64"===r)return e.toDataURL("image/png")}}}])&&b(e.prototype,n),t}();window.PaintBoard=w})();