(()=>{"use strict";const t=/Android|iPhone|iPad|iPod|SymbianOS|Windows Phone/.test(navigator.userAgent),e=t?["touchstart","touchmove","touchend"]:["mousedown","mousemove","mouseup"],n=({canvas:t,event:e})=>{let n,i,s=t.getBoundingClientRect(),r=t.width,a=t.height,o=e.x-s.x,l=e.y-s.y;return n=r*(o/s.width),i=a*(l/s.height),{x:n,y:i}},i=({ctx:t,start:e,end:n,strokeWidth:i=1,strokeColor:s="#000000",antiAliasing:r=!1})=>{t.save();for(let r=0;r<1;r++)t.beginPath(),t.lineCap="round",t.lineWidth=i,"transparent"===s?(t.strokeStyle="#ffffff",t.globalCompositeOperation="destination-out"):t.strokeStyle=s,t.moveTo(e.x,e.y),t.lineTo(n.x,n.y),t.stroke();t.restore()},s=(()=>{let s=null,r=null;return{Start:function(){s=this.canvas,r=this.ctx;const a=t=>{t.preventDefault()};let o=null;const l=e=>{let{strokeWidth:a,strokeColor:l}=this.strokeConfig,h=t?e.touches[0].pageX:e.x,c=t?e.touches[0].pageY:e.y,u=n({canvas:s,event:{x:h,y:c}});this.Operating(),i({start:o,end:u,ctx:r,strokeWidth:a,strokeColor:l}),o=u,e.preventDefault()},h=()=>{this.OperatingEnd(),document.removeEventListener(e[1],l),document.removeEventListener("selectstart",a),document.removeEventListener(e[2],h)};s["on"+e[0]]=c=>{let{strokeWidth:u,strokeColor:d}=this.strokeConfig,g=t?c.touches[0].pageX:c.x,v=t?c.touches[0].pageY:c.y;o=n({canvas:s,event:{x:g,y:v}}),this.OperatingStart(),i({start:o,end:o,ctx:r,strokeWidth:u,strokeColor:d}),document.addEventListener(e[1],l,{passive:!1}),document.addEventListener("selectstart",a),document.addEventListener(e[2],h)}},Quit:function(){s["on"+e[0]]=null}}})(),r=({type:t,ctx:e,fillStyle:n,param:i})=>{if(e.save(),e.beginPath(),"transparent"===n?(e.fillStyle="#fff",e.globalCompositeOperation="destination-out"):e.fillStyle=n,"circle"===t)((t,{x:e,y:n,radiusX:i,radiusY:s,rotation:r=2*Math.PI,startAngle:a=0,endAngle:o=2*Math.PI,counterclockwise:l=1})=>{t.ellipse(e,n,i,s,r,a,o,l)})(e,i);else if("rect"===t){let{x:t,y:n,w:s,h:r}=i;e.fillRect(t,n,s,r)}e.fill(),e.restore()},a=t=>{let e=document.createElement("canvas"),n=e.getContext("2d");return e.width=t.width,e.height=t.height,n.drawImage(t,0,0),e},o=(t,e,n)=>{let i=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),s={};return s.x=e.x+(e.x-t.x)/i*n,s.y=e.y+(e.y-t.y)/i*n,s},l=(()=>{let s=null,l=null,h=[],c=null,u=null,d=!0;const g=e=>{if(h.length>0){let i=t?e.touches[0].pageX:e.x,r=t?e.touches[0].pageY:e.y,a=n({canvas:s,event:{x:i,y:r}}),o=h[h.length-1];o.x=a.x,o.y=a.y,v()}e.preventDefault()},v=()=>{let{strokeWidth:t,strokeColor:e}=c.strokeConfig,{width:n,height:a}=c.canvas,d=h[0],g=h[1];if(l.clearRect(0,0,n,a),l.drawImage(u,0,0),d)if(g){let n=o(d,g,s.width),r=o(g,d,s.width);i({ctx:l,start:n,end:r,strokeWidth:t,strokeColor:e})}else r({ctx:l,type:"circle",fillStyle:"#000000",param:{x:d.x,y:d.y,radiusX:1,radiusY:1}})},p=()=>{h.length=0,v()},y=()=>{u=a(c.canvas)};return{name:"rline",Start:function(){u=a(this.canvas),h=[],c=this,s=this.canvas,l=this.ctx;const i=t=>{t.preventDefault()},r=()=>{2===h.length&&(d=!0,h.length=0,this.OperatingEnd(),y()),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],r),document.removeEventListener(e[1],g)};s["on"+e[0]]=a=>{if(!t&&1!==a.buttons)return;let o=t?a.touches[0].pageX:a.x,l=t?a.touches[0].pageY:a.y,c=n({canvas:s,event:{x:o,y:l}});d&&(this.OperatingStart(),d=!1),h.push(c),v(),document.addEventListener(e[1],g,{passive:!1}),document.addEventListener("selectstart",i),document.addEventListener(e[2],r)},s.oncontextmenu=t=>{t.preventDefault(),p(),this.OperatingEnd(),u=a(s)}},Quit:function(){p(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],g)},UpdateClone:y}})(),h=(()=>{let s=null,o=null,l=[],h=null,c=null,u=!0;const d=e=>{if(l.length>0){let i=t?e.touches[0].pageX:e.x,r=t?e.touches[0].pageY:e.y,a=n({canvas:s,event:{x:i,y:r}}),o=l[l.length-1];o.x=a.x,o.y=a.y,g()}e.preventDefault()},g=()=>{let{strokeWidth:t,strokeColor:e}=h.strokeConfig,{width:n,height:a}=h.canvas,u=l[0],d=l[1];if(o.clearRect(0,0,n,a),o.drawImage(c,0,0),u)if(d){let n=((t,e,n)=>{let i=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),s={};return s.x=e.x+(e.x-t.x)/i*n,s.y=e.y+(e.y-t.y)/i*n,s})(u,d,s.width);i({ctx:o,start:u,end:n,strokeWidth:t,strokeColor:e})}else r({ctx:o,type:"circle",fillStyle:"#000000",param:{x:u.x,y:u.y,radiusX:1,radiusY:1}})},v=()=>{l.length=0,g()},p=()=>{c=a(h.canvas)};return{name:"rline",Start:function(){c=a(this.canvas),l=[],h=this,s=this.canvas,o=this.ctx;const i=t=>{t.preventDefault()},r=()=>{2===l.length&&(u=!0,l.length=0,this.OperatingEnd(),p()),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],r),document.removeEventListener(e[1],d)};s["on"+e[0]]=a=>{if(!t&&1!==a.buttons)return;let o=t?a.touches[0].pageX:a.x,h=t?a.touches[0].pageY:a.y,c=n({canvas:s,event:{x:o,y:h}});u&&(this.OperatingStart(),u=!1),l.push(c),g(),document.addEventListener(e[1],d,{passive:!1}),document.addEventListener("selectstart",i),document.addEventListener(e[2],r)},s.oncontextmenu=t=>{t.preventDefault(),v(),this.OperatingEnd(),c=a(s)}},Quit:function(){v(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],d)},UpdateClone:p}})(),c=(()=>{let s=null,o=null,l=[],h=null,c=null,u=!0;const d=e=>{if(l.length>0){let i=t?e.touches[0].pageX:e.x,r=t?e.touches[0].pageY:e.y,a=n({canvas:s,event:{x:i,y:r}}),o=l[l.length-1];o.x=a.x,o.y=a.y,g()}e.preventDefault()},g=()=>{let{strokeWidth:t,strokeColor:e}=h.strokeConfig,{width:n,height:s}=h.canvas,a=l[0],u=l[1];o.clearRect(0,0,n,s),o.drawImage(c,0,0),a&&(u?i({ctx:o,start:a,end:u,strokeWidth:t,strokeColor:e}):r({ctx:o,type:"circle",fillStyle:"#000000",param:{x:a.x,y:a.y,radiusX:1,radiusY:1}}))},v=()=>{l.length=0,g()},p=()=>{c=a(h.canvas)};return{name:"line",Start:function(){c=a(this.canvas),l=[],h=this,s=this.canvas,o=this.ctx;const i=t=>{t.preventDefault()},r=()=>{2===l.length&&(u=!0,l.length=0,this.OperatingEnd(),p()),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],r),document.removeEventListener(e[1],d)};s["on"+e[0]]=a=>{if(!t&&1!==a.buttons)return;let o=t?a.touches[0].pageX:a.x,h=t?a.touches[0].pageY:a.y,c=n({canvas:s,event:{x:o,y:h}});u&&(this.OperatingStart(),u=!1),l.push(c),g(),document.addEventListener(e[1],d,{passive:!1}),document.addEventListener("selectstart",i),document.addEventListener(e[2],r)},s.oncontextmenu=t=>{t.preventDefault(),v(),this.OperatingEnd(),c=a(s)}},Quit:function(){v(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],d)},UpdateClone:p}})(),u=(()=>{let s=null,a=null;return{Start:function(){let o=null;s=this.canvas,a=this.ctx;const l=t=>{t.preventDefault()},h=e=>{let{clearRadius:l,clearColor:h}=this,c=t?e.touches[0].pageX:e.x,u=t?e.touches[0].pageY:e.y,d=n({canvas:s,event:{x:c,y:u}});this.Operating(),o?i({start:o,end:d,ctx:a,strokeWidth:2*l,strokeColor:h}):r({ctx:a,type:"circle",fillStyle:h,param:{x:d.x,y:d.y,radiusX:l,radiusY:l}}),o=d,e.preventDefault()},c=()=>{o=null,this.OperatingEnd(),document.removeEventListener(e[1],h),document.removeEventListener("selectstart",l),document.removeEventListener(e[2],c)};s["on"+e[0]]=i=>{let{clearRadius:o,clearColor:u}=this,d=t?i.touches[0].pageX:i.x,g=t?i.touches[0].pageY:i.y,v=n({canvas:s,event:{x:d,y:g}});this.OperatingStart(),r({ctx:a,type:"circle",fillStyle:u,param:{x:v.x,y:v.y,radiusX:o,radiusY:o}}),document.addEventListener(e[1],h,{passive:!1}),document.addEventListener("selectstart",l),document.addEventListener(e[2],c)}},Quit:function(){s["on"+e[0]]=null}}})(),d=(()=>{let s=null,r=null,o=[],l=null,h=null,c=!0;const u=e=>{if(o.length>0){let i=t?e.touches[0].pageX:e.x,r=t?e.touches[0].pageY:e.y,a=n({canvas:s,event:{x:i,y:r}}),l=o[o.length-1];l.x=a.x,l.y=a.y,d()}},d=()=>{let{strokeWidth:t,strokeColor:e}=l.strokeConfig,{width:n,height:s}=l.canvas;r.clearRect(0,0,n,s),r.drawImage(h,0,0);for(let n=0;n<o.length;n++){let s=null,a=o[n];s=0===o.length?a:0===n?o[o.length-1]:o[n-1],i({ctx:r,start:s,end:a,strokeWidth:t,strokeColor:e})}},g=()=>{t||o.length>0&&(o.length-=1),o.length<3&&(o.length=0),d(),o.length=0};return{name:"polygon",Start:function(){h=a(this.canvas),o=[],l=this,s=this.canvas,r=this.ctx;const i=t=>{t.preventDefault()},v=()=>{if(0!==o.length){if(!t){let{x:t,y:e}=o[o.length-1];o.push({x:t,y:e})}o.length>3&&this.OperatingEnd(),d(),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],v)}};s["on"+e[0]]=r=>{if(!t&&1!==r.buttons)return;let a=t?r.touches[0].pageX:r.x,l=t?r.touches[0].pageY:r.y,h=n({canvas:s,event:{x:a,y:l}});(t||0===o.length)&&o.push({...h}),c&&(this.OperatingStart(),c=!1),document.addEventListener("selectstart",i),document.addEventListener(e[2],v)},s.oncontextmenu=t=>{t.preventDefault(),g(),this.OperatingEnd(),h=a(s)},t||document.addEventListener(e[1],u)},Quit:function(){g(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],u)},UpdateClone:()=>{h=a(l.canvas)}}})();let g=!1,v=!1;const p=(t,e)=>{var n=0;return Object.keys(t).map((i=>{n+=(t[i]-e[i])**2})),Math.sqrt(n)},y=({imageData:t,coord:e})=>{let{x:n,y:i}=e,{width:s,height:r,data:a}=t;var o=i*(4*s)+4*n;return{r:a[o],g:a[o+1],b:a[o+2],a:a[o+3]}};function x(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const f={pen:s,rline:l,hline:h,line:c,eraser:u,polygon:d,paintBucket:(()=>{let i=null,s=null,r=!1;return{Start:function(){i=this.canvas,s=this.ctx,i["on"+e[0]]=e=>{if(r)return void console.log("bucket doing");let{strokeColor:a}=this.strokeConfig,o=t?e.touches[0].pageX:e.x,l=t?e.touches[0].pageY:e.y,h=n({canvas:i,event:{x:o,y:l}});this.OperatingStart(),(({ctx:t,currCoord:e,inputColor:n,cb:i})=>{let s=Math.round(e.x),r=Math.round(e.y),{width:a,height:o}=t.canvas,l=t.getImageData(0,0,a,o),h=y({coord:{x:s,y:r},imageData:l}),c={},u=[[s,r]],d=!1,x=null;if(v)console.warn("task running.");else if(v=!0,g=!1,n=(t=>{let e;if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t))return e=t.substring(1).split(""),3===e.length&&(e=[e[0],e[0],e[1],e[1],e[2],e[2]]),e="0x"+e.join(""),{r:e>>16&255,g:e>>8&255,b:255&e,a:255};throw new Error("Bad Hex")})(n),0!==p(n,h))try{!function e(){let n=u;if(d=!1,x=500,u=[],g)throw v=!1,new Error("User interrupt");for(let t of n){let[e,n]=t;f(e,n)}d?setTimeout((function(){e()}),0):(v=!1,t.putImageData(l,0,0),i&&i("done"))}()}catch(t){i&&i(t)}else i&&i("same color");function f(t,e){if(g)return;if(c[t+"_"+e]&&c[t+"_"+e]++,x--<0)return d=!0,void u.push([t,e]);let i=y({coord:{x:t,y:e},imageData:l});if(p(h,i)<10){(({imageData:t,coord:e,rgba:n})=>{let{x:i,y:s}=e,{width:r,height:a,data:o}=t;var l=s*(4*r)+4*i;let{r:h,g:c,b:u,a:d}=n;d=d||255,o[l]=h,o[l+1]=c,o[l+2]=u,o[l+3]=d})({imageData:l,rgba:n,coord:{x:t,y:e}}),c[t+"_"+e]=!0;for(let n=t-1;n<t+2;n++)for(let t=e-1;t<e+2;t++)0<=n&&n<a&&0<=t&&t<o&&!c[n+"_"+t]&&(c[n+"_"+t]=!0,f(n,t))}}})({inputColor:a,currCoord:h,ctx:s,cb:t=>{r=!1,this.OperatingEnd()}})}},Quit:function(){g=!0,i["on"+e[0]]=null}}})()};window.PaintBoard=class{constructor({canvas:t,strokeConfig:e={},clearColor:n="#ffffff",clearRadius:i=16,enableHistory:s=!1,historyMax:r=10,historyInterval:a=500,background:o,...l}){x(this,"lastOperatingEnd",null),x(this,"isContinuous",null),x(this,"currentTool",null),x(this,"strokeConfig",{strokeWidth:1,strokeColor:"#000000"}),this.props=l;let h=this.props;if(h.logicalWidth=Math.round(h.logicalWidth),h.logicalHeight=Math.round(h.logicalHeight),t.width=h.logicalWidth,t.height=h.logicalHeight,Object.assign(this.strokeConfig,e),o){let{image:e,color:n}=o;t.style.background="".concat(n||""," url(").concat(e.src,") 0 0 no-repeat"),t.style.backgroundSize="contain",t.style.backgroundSize="100% 100%"}this.background=o,this.clearColor=n,this.historyInterval=a,this.clearRadius=i,this.canvas=t,this.ctx=t.getContext("2d"),s&&(this.enableHistory=s,this.historyMax=r,this.historyIndex=-1,this.historyStack=[]),this.Clear()}Tool(t){const e=f[t];this.currentTool?(this.currentTool.Quit(),this.currentTool===e?this.currentTool=null:(this.currentTool=e,e.Start.apply(this))):(this.currentTool=e,e.Start.apply(this))}Method(t){this.currentTool&&this.currentTool.Quit(),this[t=t.substr(0,1).toUpperCase()+t.substr(1,t.length)](),this.currentTool&&"polygon"===this.currentTool.name&&this.currentTool.UpdateClone(),this.currentTool&&this.currentTool.Start.apply(this)}OperatingStart(){this.enableHistory&&(this.isClean=!1,this.ClearRedoList(),this.isContinuous=Date.now()-this.lastOperatingEnd<this.historyInterval)}Operating(){}OperatingEnd(){this.lastOperatingEnd=Date.now(),this.enableHistory&&(this.Snapshot(this.isContinuous),this.lastOperatingEnd=Date.now())}Clear(){if(this.CleanBoard(),this.enableHistory){this.ClearRedoList();let t=this.historyStack[this.historyIndex];if(t&&"clear"===t.t)return;this.historyIndex+=1,this.Snapshot()}}CleanBoard(){this.ctx.save(),"transparent"===this.clearColor?(this.ctx.fillStyle="#ffffff",this.ctx.globalCompositeOperation="destination-out"):this.ctx.fillStyle=this.clearColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}ClearRedoList(){this.historyStack.length=this.historyIndex+1}ApplyHistory(){let t=this.historyStack[this.historyIndex];if(t)if("init"===t.t||"clear"===t.t)this.CleanBoard(),this.isClean=!0;else{let e=new ImageData(t.data,this.canvas.width,this.canvas.height);this.ctx.putImageData(e,0,0)}}Undo(){this.enableHistory&&0!==this.historyStack.length&&(this.historyIndex-=1,this.historyIndex<0&&(this.historyIndex=0),this.ApplyHistory())}Redo(){this.enableHistory&&0!==this.historyStack.length&&(this.historyIndex+=1,this.historyIndex>this.historyStack.length-1?this.historyIndex=this.historyStack.length-1:this.ApplyHistory())}Snapshot(t=!1){let e=null;e=this.isClean?{t:"clear"}:{time:Date.now(),data:this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height).data},t&&this.historyStack.pop(),this.historyStack.length>=this.historyMax&&this.historyStack.shift(),this.historyStack.push(e),this.historyIndex=this.historyStack.length-1}SaveData({returnType:t="arraybuffer",compBg:e=!1,cb:n}){let i,{logicalWidth:s,logicalHeight:r}=this.props;if(e){let t,{image:e}=this.background;i=document.createElement("canvas"),i.width=s,i.height=r,t=i.getContext("2d"),t.drawImage(e,0,0,s,r),t.drawImage(this.canvas,0,0,s,r)}else i=this.canvas;if("file"===t)i.toBlob((t=>{let e=new File([t],"user-board.png",{lastModified:new Date});n(e)}),"image/png");else{if("arraybuffer"===t)return this.ctx.getImageData(0,0,s,r).data.buffer;if("base64"===t)return i.toDataURL("image/png")}}}})();